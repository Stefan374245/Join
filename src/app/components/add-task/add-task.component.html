<!-- Main Wrapper with conditional classes -->
<div [class.task-edit-overlay]="isOverlay"
     [class.add-task-container]="!isOverlay"
     (click)="isOverlay ? onOverlayClick($event) : null"
     role="dialog"
     [attr.aria-modal]="isOverlay"
     [attr.aria-labelledby]="isEditMode ? 'edit-task-title' : 'add-task-title'">

  <!-- Content Card (only for overlay) -->
  <article [class.task-edit-card]="isOverlay"
       (click)="isOverlay ? $event.stopPropagation() : null">

    <!-- Close Button (only for overlay) -->
    <button *ngIf="isOverlay" class="close-btn" (click)="onClose()" aria-label="Close dialog">
      <img src="/assets/images/close.svg" alt="" role="presentation" />
    </button>

    <!-- Header Section -->
    <header [class.edit-header]="isOverlay" [class.add-task-header]="!isOverlay">
      <h1 [class.edit-title]="isOverlay"
          [class.page-title]="!isOverlay"
          [id]="isEditMode ? 'edit-task-title' : 'add-task-title'">
        {{ isEditMode ? 'Edit Task' : 'Add Task' }}
      </h1>
    </header>

    <!-- Form Container -->
    <main class="form-wrapper">
      <form [formGroup]="taskForm" (ngSubmit)="onSubmit()" class="add-task-form" aria-label="Task form">
      <!-- Left Column -->
      <section class="form-column form-column-left" aria-labelledby="basic-info-heading">
        <!-- Title Input -->
        <fieldset class="form-group">
          <label for="title" class="form-label">
            Title<span class="required" aria-label="required">*</span>
          </label>
          <input
            type="text"
            id="title"
            formControlName="title"
            class="form-input"
            [class.error]="f['title'].touched && f['title'].errors"
            placeholder="Enter a title"
            aria-required="true"
            [attr.aria-invalid]="f['title'].touched && f['title'].errors"
            [attr.aria-describedby]="f['title'].touched && f['title'].errors ? 'title-error' : null"
          />
          <span class="error-message"
                id="title-error"
                *ngIf="f['title'].touched && f['title'].errors"
                role="alert">
            Title is required (min. 3 characters)
          </span>
        </fieldset>

        <!-- Description Textarea -->
        <fieldset class="form-group">
          <label for="description" class="form-label">Description</label>
          <textarea
            id="description"
            formControlName="description"
            class="form-textarea"
            rows="4"
            placeholder="Enter a Description"
            spellcheck="false"
            aria-label="Task description"
          ></textarea>
        </fieldset>

        <!-- Due Date Input -->
        <fieldset class="form-group">
          <label for="dueDate" class="form-label">
            Due date<span class="required" aria-label="required">*</span>
          </label>
          <div class="input-wrapper">
            <input
              type="date"
              id="dueDate"
              formControlName="dueDate"
              class="form-input"
              [class.error]="f['dueDate'].touched && f['dueDate'].errors"
              [min]="minDate"
              placeholder="dd/mm/yyyy"
              aria-required="true"
              [attr.aria-invalid]="f['dueDate'].touched && f['dueDate'].errors"
              [attr.aria-describedby]="f['dueDate'].touched && f['dueDate'].errors ? 'dueDate-error' : null"
            />
          </div>
          <span class="error-message"
                id="dueDate-error"
                *ngIf="f['dueDate'].touched && f['dueDate'].errors"
                role="alert">
            Due date is required
          </span>
        </fieldset>
      </section>

      <!-- Separator -->
      <hr class="separator" aria-hidden="true" />

      <!-- Right Column -->
      <section class="form-column form-column-right" aria-labelledby="task-details-heading">

        <!-- Priority Selection -->
        <fieldset class="form-group">
          <legend class="form-label">Priority</legend>
          <div class="priority-buttons" role="group" aria-label="Priority selection">
            <button
              type="button"
              [ngClass]="{
                'priority-btn': true,
                'priority-btn-urgent': true,
                'priority-btn-active': selectedPriority === 'high'
              }"
              (click)="selectPriority('high')"
              [attr.aria-pressed]="selectedPriority === 'high'"
              aria-label="Set priority to urgent">
              <span>Urgent</span>
              <img
                [src]="selectedPriority === 'high' ? '/assets/images/urgentwhite.svg' : '/assets/images/urgent.svg'"
                alt=""
                role="presentation" />
            </button>
            <button
              type="button"
              [ngClass]="{
                'priority-btn': true,
                'priority-btn-medium': true,
                'priority-btn-active': selectedPriority === 'medium'
              }"
              (click)="selectPriority('medium')"
              [attr.aria-pressed]="selectedPriority === 'medium'"
              aria-label="Set priority to medium">
              <span>Medium</span>
              <img
                [src]="selectedPriority === 'medium' ? '/assets/images/mediumwhite.svg' : '/assets/images/medium.svg'"
                alt=""
                role="presentation" />
            </button>
            <button
              type="button"
              [ngClass]="{
                'priority-btn': true,
                'priority-btn-low': true,
                'priority-btn-active': selectedPriority === 'low'
              }"
              (click)="selectPriority('low')"
              [attr.aria-pressed]="selectedPriority === 'low'"
              aria-label="Set priority to low">
              <span>Low</span>
              <img
                [src]="selectedPriority === 'low' ? '/assets/images/lowwhite.svg' : '/assets/images/low.svg'"
                alt=""
                role="presentation" />
            </button>
          </div>
        </fieldset>

        <!-- Assigned To Dropdown -->
        <fieldset class="form-group">
          <legend class="form-label">Assigned to</legend>
          <div class="input-wrapper" (click)="toggleContactDropdown()">
            <input
              type="text"
              id="assignedTo"
              class="form-input"
              [placeholder]="selectedContacts.length > 0 ? selectedContacts.length + ' contact(s) selected' : 'Select contacts to assign'"
              readonly
              aria-haspopup="listbox"
              [attr.aria-expanded]="showContactDropdown"
              aria-label="Assigned contacts"
            />
            <img src="/assets/images/arrow_drop_down.svg" alt="" class="dropdown-icon" role="presentation" />
          </div>

          <!-- Contact Dropdown -->
          <ul class="dropdown-menu"
              *ngIf="showContactDropdown"
              role="listbox"
              aria-label="Contact selection">
            <li
              *ngFor="let contact of availableContacts"
              class="dropdown-item"
              [class.selected]="isContactSelected(contact)"
              (click)="selectContact(contact)"
              role="option"
              [attr.aria-selected]="isContactSelected(contact)"
              tabindex="0">
              <div class="contact-info">
                <div class="avatar"
                     [style.background-color]="contact.color"
                     [attr.aria-label]="contact.firstName + ' ' + contact.lastName">
                  {{ contact.initials }}
                </div>
                <span>{{ contact.firstName }} {{ contact.lastName }}</span>
              </div>
              <img
                [src]="isContactSelected(contact) ? '/assets/images/checkboxtruewhite.svg' : '/assets/images/checkboxfalseblack.svg'"
                alt=""
                class="check-icon"
                role="presentation" />
            </li>
          </ul>

          <!-- Selected Contacts Display -->
          <div class="selected-contacts"
               *ngIf="selectedContacts.length > 0"
               role="list"
               aria-label="Selected contacts">
            <div
              *ngFor="let contact of selectedContacts"
              class="contact-badge"
              [style.background-color]="contact.color"
              role="listitem"
              [attr.aria-label]="contact.firstName + ' ' + contact.lastName">
              {{ contact.initials }}
              <img
                src="/assets/images/close.svg"
                alt="Remove contact"
                class="remove-icon"
                (click)="removeContact(contact.id)"
                role="button"
                tabindex="0" />
            </div>
          </div>
        </fieldset>

        <!-- Category Dropdown -->
        <fieldset class="form-group">
          <legend class="form-label">
            Category<span class="required" aria-label="required">*</span>
          </legend>
          <div class="input-wrapper" (click)="toggleCategoryDropdown()">
            <input
              type="text"
              id="category"
              class="form-input"
              [class.error]="f['category'].touched && f['category'].errors"
              [placeholder]="selectedCategory || 'Select task category'"
              readonly
              aria-required="true"
              aria-haspopup="listbox"
              [attr.aria-expanded]="showCategoryDropdown"
              [attr.aria-invalid]="f['category'].touched && f['category'].errors"
              [attr.aria-describedby]="f['category'].touched && f['category'].errors ? 'category-error' : null"
              aria-label="Task category"
            />
            <img src="/assets/images/arrow_drop_down.svg" alt="" class="dropdown-icon" role="presentation" />
          </div>

          <!-- Category Dropdown -->
          <ul class="dropdown-menu"
              *ngIf="showCategoryDropdown"
              role="listbox"
              aria-label="Category selection">
            <li
              *ngFor="let category of categories"
              class="dropdown-item"
              (click)="selectCategory(category)"
              role="option"
              [attr.aria-selected]="selectedCategory === category"
              tabindex="0">
              <span>{{ category }}</span>
            </li>
          </ul>

          <span class="error-message"
                id="category-error"
                *ngIf="f['category'].touched && f['category'].errors"
                role="alert">
            Category is required
          </span>
        </fieldset>

        <!-- Subtasks Section -->
        <fieldset class="form-group">
          <legend class="form-label">Subtasks</legend>
          <div class="input-wrapper subtask-input-wrapper">
            <input
              type="text"
              id="subtask"
              class="form-input subtask-input"
              [(ngModel)]="subtaskInput"
              [ngModelOptions]="{standalone: true}"
              placeholder="Add new subtask"
              (focus)="onSubtaskInputFocus()"
              (blur)="onSubtaskInputBlur()"
              (keydown.enter)="editingSubtaskId ? updateSubtask() : addSubtask(); $event.preventDefault()"
              maxlength="35"
              aria-label="Subtask input"
              #subtaskInputRef
            />
            <img
              *ngIf="!subtaskInputFocused && !subtaskInput"
              src="/assets/images/addDark.svg"
              alt="Add subtask"
              class="subtask-add-icon-absolute"
              (click)="subtaskInputRef.focus()"
              tabindex="0"
              role="button"
            />
            <div class="subtask-actions" *ngIf="subtaskInputFocused || subtaskInput">
              <img
                src="/assets/images/close.svg"
                alt="Clear subtask input"
                class="subtask-icon subtask-clear"
                (click)="clearSubtaskInput()"
                role="button"
                tabindex="0" />
              <div class="subtask-divider" aria-hidden="true"></div>
              <img
                src="/assets/images/checkDark.svg"
                [attr.alt]="editingSubtaskId ? 'Update subtask' : 'Add subtask'"
                class="subtask-icon subtask-add"
                (click)="editingSubtaskId ? updateSubtask() : addSubtask()"
                role="button"
                tabindex="0"
                alt="checkicon" />
            </div>
          </div>

          <!-- Subtasks List -->
          <app-subtask-list
            [subtasks]="subtasks"
            [editingSubtaskId]="editingSubtaskId"
            [subtaskEditInput]="subtaskEditInput"
            (editSubtask)="editSubtask($event)"
            (deleteSubtask)="deleteSubtask($event)"
            (updateSubtask)="updateSubtask()"
            (cancelEditSubtask)="cancelEditSubtask()"
            (addSubtask)="addSubtask()"
          ></app-subtask-list>
        </fieldset>
      </section>
    </form>

    <!-- Required Label -->
    <p class="required-label">
      <span aria-hidden="true">*</span>This field is required
    </p>

    <!-- Form Actions -->
    <footer class="form-actions">
      <button type="button" class="btn btn-secondary" (click)="clearForm()" aria-label="Clear form">
        Clear
        <img src="/assets/images/close.svg" alt="" role="presentation" />
      </button>
      <button type="submit"
              class="btn btn-primary"
              [disabled]="taskForm.invalid"
              (click)="onSubmit()"
              [attr.aria-label]="isEditMode ? 'Update task' : 'Create task'">
        {{ isEditMode ? 'Update Task' : 'Create Task' }}
        <img src="/assets/images/check.svg" alt="" role="presentation" />
      </button>
    </footer>
  </main>
  </article>
</div>

